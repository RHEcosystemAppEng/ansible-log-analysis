from __future__ import annotations

from datetime import datetime
from typing import Dict, Optional

from sqlalchemy import JSON
from sqlmodel import Column, Field, SQLModel
from enum import Enum

from pydantic import BaseModel
import pydantic


# DB / API models
class GrafanaAlert(SQLModel, table=True):
    """Grafana alert payload for Loki log alerts."""

    # # Optional ID field
    id: Optional[int] = Field(default=None, primary_key=True)

    # Grouping information
    logTimestamp: Optional[datetime] = Field(
        default_factory=datetime.now, description="Timestamp of the log message"
    )
    logMessage: str = Field(description="Original log message that triggered the alert")
    logSummary: str = Field(
        default="No summary available", description="Summary of the log message"
    )
    expertClassification: Optional[str] = Field(
        default=None, description="Classification of the log message"
    )
    logCluster: Optional[str] = Field(
        default=None, description="Cluster of the log message"
    )
    needMoreContext: Optional[bool] = Field(
        default=None, description="Is additional context needed to solve the problem"
    )
    stepByStepSolution: Optional[str] = Field(
        default=None, description="Step by step solution to the problem"
    )
    contextForStepByStepSolution: Optional[str] = Field(
        default=None, description="Context for the step by step solution"
    )
    log_labels: Dict[str, str] = Field(
        default={},
        description="Loki log metadata, dict representation of LogLabels",
        sa_column=Column(JSON),
    )
    # logLevel: Optional[str] = None  # Log level from Loki logs (info, warn, error, etc.)
    # logSource: Optional[str] = None  # Source of the log (e.g., service name, pod name)

    # log_type: Optional[str] = None
    # task_name: Optional[str] = None


# Input models
class LogLevel(str, Enum):
    ERROR = "error"
    WARN = "warn"
    INFO = "info"
    DEBUG = "debug"
    UNKNOWN = "unknown"
    # FATAL = "fatal" # This type of error ask yossi what he thinks to do.


class LogLabels(BaseModel):
    """Metadata labels for a single log entry from Loki"""

    detected_level: Optional[LogLevel] = pydantic.Field(
        default=None, description="Detected level of the log"
    )
    filename: Optional[str] = pydantic.Field(
        default=None, description="Filename of the log"
    )
    job: Optional[str] = pydantic.Field(default=None, description="Job of the log")
    service_name: Optional[str] = pydantic.Field(
        default=None, description="Service name of the log"
    )


class LogEntry(BaseModel):
    """Represents a single log entry from Loki"""

    timestamp: str = pydantic.Field(
        default="Unknown timestamp", description="Timestamp of the log"
    )
    log_labels: LogLabels = pydantic.Field(description="Log labels of the log")
    message: str = pydantic.Field(description="Message of the log")
